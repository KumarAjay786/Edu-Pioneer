{% extends "base.html" %}
{% block start %}
{% load static %}
<style>
    .alert {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        animation: slideIn 0.5s forwards;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .alert-dismissible .btn-close {
        padding: 0.5rem 0.5rem;
    }
</style>
<!-- Hero Section -->
<section class="apply-hero position-relative">
    <div class="apply-pattern" style="top: 50px; left: 50px;"></div>
    <div class="apply-pattern" style="bottom: 50px; right: 50px;"></div>
    <div class="container position-relative z-1">
        <div class="row justify-content-center text-center">
            <div class="col-lg-8 animate__animated animate__fadeIn">
                <h1 class="apply-title mb-4">Begin Your Journey</h1>
                <p class="lead fs-3 mb-5" style="color: #2F4F4F;">Join our prestigious programs with this seamless
                    application process</p>
                <a href="#applyForm" class="apply-btn btn-lg animate__animated animate__pulse animate__infinite">Start
                    Application</a>
            </div>
        </div>
    </div>
</section>

<!-- Application Form Section -->
<section id="applyForm" class="py-5 position-relative">
    <div class="apply-pattern" style="bottom: 100px; left: 100px;"></div>
    <div class="container py-5 position-relative z-1">
        <div class="row justify-content-center">
            <div class="col-lg-10 animate__animated animate__fadeIn">
                <div class="apply-card p-4 p-md-5">
                    <div class="row">
                        <div class="col-lg-5 d-flex align-items-center"
                            style="background: linear-gradient(135deg, var(--sky-blue), var(--light-green));">
                            <div class="p-4 txt_blk">
                                <h2 class="mb-4">Ready to Apply?</h2>
                                <p class="mb-4">Our admissions team is ready to review your application. Please
                                    complete all sections carefully.</p>
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-check-circle me-3 fs-4"></i>
                                    <span>Secure online form</span>
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-check-circle me-3 fs-4"></i>
                                    <span>24/7 application access</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle me-3 fs-4"></i>
                                    <span>Real-time status updates</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-7 p-4 p-md-5">
                            <h3 class="mb-4">Application Form</h3>
                            {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags %}{{ message.tags }}{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
                            <form id="studentForm" method="post">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="firstName" class="form-label">First Name<span
                                                class="red_colored_requred_mark">*</span></label>
                                        <input type="text" class="form-control" id="firstName" name="firstName"
                                            required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lastName" class="form-label">Last Name<span
                                                class="red_colored_requred_mark">*</span></label>
                                        <input type="text" class="form-control" id="lastName" name="lastName" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="courseType" class="form-label">Course Type<span
                                                class="red_colored_requred_mark">*</span></label>
                                        <select class="form-select" id="courseType" name="courseType" required>
                                            <option value="" selected disabled>Select course type</option>
                                            <option value="pu">Pre-University (PU/12th)</option>
                                            <option value="diploma">Diploma</option>
                                            <option value="degree">Degree (UG)</option>
                                            <option value="integrated">Integrated Degree</option>
                                            <option value="master">Master's Degree (PG)</option>
                                            <option value="phd">PhD/Doctorate</option>
                                            <option value="pg_diploma">PG Diploma</option>
                                            <option value="certificate">Certificate Course</option>
                                            <option value="vocational">Vocational Training</option>
                                            <option value="distance">Distance Education</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="course" class="form-label">Select Course<span
                                                class="red_colored_requred_mark">*</span></label>
                                        <select class="form-select" id="course" name="course" required disabled>
                                            <option value="" selected disabled>First select course type</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="maxFees" class="form-label">Maximum Fees<span
                                                class="red_colored_requred_mark">*</span></label>
                                        <input type="number" class="form-control" id="maxFees" name="maxFees" min="0"
                                            placeholder="â‚¹..." required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="minFees" class="form-label">Country<span
                                                class="red_colored_requred_mark">*</span></label>
                                        <!-- <input type="text" class="form-control" id="Country" name="Country" min="0" placeholder="Enter country name" required> -->
                                        <select id="apply-country" name="apply-country" class="form-select" required>
                                            <option value="">Select Country</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="state" class="form-label">Select State<span
                                                class="red_colored_requred_mark">*</span></label>
                                        <select class="form-select" id="apply-state" name="apply-state" required>
                                            <option value="" selected disabled>Select state</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="district" class="form-label">Select District<span
                                                class="red_colored_requred_mark">*</span></label>
                                        <select class="form-select" id="apply-district" name="apply-district" required>
                                            <option value="" selected disabled>First select state</option>
                                        </select>
                                    </div>

                                    <div class="col-md-12">
                                        <label for="collegeName" class="form-label">Colleges Available in <span
                                                id="selectedDistrict"></span></label>
                                        <select class="form-select" id="collegeName" name="collegeName">
                                            <option value="" selected disabled>Select college name</option>
                                        </select>
                                        <script>
                                            document.addEventListener('DOMContentLoaded', function () {
                                                const stateSelect = document.getElementById('apply-state');
                                                const districtSelect = document.getElementById('apply-district');
                                                const collegeSelect = document.getElementById('collegeName');
                                                const selectedDistrictSpan = document.getElementById('selectedDistrict');

                                                districtSelect.addEventListener('change', function () {
                                                    const state = stateSelect.value;
                                                    const district = districtSelect.value;

                                                    selectedDistrictSpan.textContent = districtSelect.options[districtSelect.selectedIndex].text;

                                                    if (state && district) {
                                                        fetch(`/apply/?state=${state}&district=${district}`, {
                                                            headers: {
                                                                'X-Requested-With': 'XMLHttpRequest'
                                                            }
                                                        })
                                                            .then(response => response.json())
                                                            .then(data => {
                                                                // Clear current options
                                                                collegeSelect.innerHTML = '<option value="" selected disabled>Select college name</option>';

                                                                if (data.colleges.length > 0) {
                                                                    data.colleges.forEach(college => {
                                                                        const opt = document.createElement('option');
                                                                        opt.value = college.name;
                                                                        opt.textContent = college.name;
                                                                        collegeSelect.appendChild(opt);
                                                                    });
                                                                } else {
                                                                    const opt = document.createElement('option');
                                                                    opt.textContent = "No colleges found for this district";
                                                                    opt.disabled = true;
                                                                    collegeSelect.appendChild(opt);
                                                                }
                                                            });
                                                    }
                                                });
                                            });

                                        </script>
                                    </div>
                                    <script>
                                        const dist = document.getElementById('apply-district');
                                        const selectedDistrictSpan = document.getElementById('selectedDistrict');

                                        dist.addEventListener('change', function () {
                                            const selectedValue = this.value;
                                            const selectedText = this.options[this.selectedIndex].text;

                                            selectedDistrictSpan.textContent = selectedText;

                                            // You would typically filter or update the 'collegeName' options here
                                            // based on the selected district. For this example, the college
                                            // names in the second dropdown have the district in parentheses.
                                        });
                                    </script>
                                    <div class="col-md-6">
                                        <label for="mobile" class="form-label">Mobile Number<span
                                                class="red_colored_requred_mark">*</span></label>
                                        <input type="tel" class="form-control" id="mobile" name="mobile"
                                            pattern="[0-9]{10}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="email" class="form-label">Email Address<span
                                                class="red_colored_requred_mark">*</span></label>
                                        <input type="email" class="form-control" id="email" name="email" required>
                                    </div>
                                    <div class="col-12">
                                        <label for="address" class="form-label">Address</label>
                                        <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                                    </div>
                                    <div class="col-12 mt-4">
                                        <button type="submit" class="btn btn-primary w-100 py-2">Submit
                                            Registration</button>
                                    </div>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/applypage.js' %}"></script>
<script src="{% static 'js/courses.js' %}"></script>
<!-- Custom JS -->
<script>
    // Animation trigger on scroll
    document.addEventListener('DOMContentLoaded', function () {
        const animateElements = document.querySelectorAll('.animate__animated');

        const animateOnScroll = function () {
            animateElements.forEach(element => {
                const elementPosition = element.getBoundingClientRect().top;
                const windowHeight = window.innerHeight;

                if (elementPosition < windowHeight - 100) {
                    const animationClass = element.classList.item(1);
                    element.classList.add(animationClass);
                }
            });
        };

        // Initial check
        animateOnScroll();

        // Check on scroll
        window.addEventListener('scroll', animateOnScroll);

        // Add hover class to cards on touch devices
        if ('ontouchstart' in window) {
            document.querySelectorAll('.apply-card').forEach(card => {
                card.addEventListener('touchstart', function () {
                    this.classList.add('hover');
                }, { passive: true });
            });
        }
    });
</script>
<!-- Add this script to your form -->
<script>
   document.getElementById('studentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData(this);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Convert FormData to JSON for better error handling
        const jsonData = {};
        formData.forEach((value, key) => jsonData[key] = value);
        
        const response = await fetch("{% url 'save_student' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(jsonData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.message || `Server returned ${response.status}`);
        }
        
        // Success case
        showAlert('success', data.message || 'Registration successful!');
        this.reset();
        
    } catch (error) {
        // Error case
        showAlert('danger', error.message || 'Failed to submit form');
        console.error('Error:', error);
        
    } finally {
        // Restore button state
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    }
});

// Helper function to show alerts
function showAlert(type, message) {
    // Remove existing alerts
    document.querySelectorAll('.custom-alert').forEach(el => el.remove());
    
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `custom-alert alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Add to DOM
    document.body.appendChild(alertDiv);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 150);
    }, 5000);
}
</script>
{% endblock %}